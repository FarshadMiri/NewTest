@{
    ViewData["Title"] = "تقویم وظایف";
}

<h2>تقویم وظایف</h2>

<!-- لینک به فایل‌های استایل persian-datepicker -->
<link rel="stylesheet" href="https://babakhani.github.io/PersianWebToolkit/beta/lib/persian-datepicker/dist/css/persian-datepicker.css" />

<div id="datepicker"></div>
<div id="taskList"></div> <!-- اینجا لیست وظایف نمایش داده می‌شود -->
@section Scripts {
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://babakhani.github.io/PersianWebToolkit/beta/lib/persian-date/dist/persian-date.js"></script>
    <script src="https://babakhani.github.io/PersianWebToolkit/beta/lib/persian-datepicker/dist/js/persian-datepicker.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.12/dist/browser/signalr.min.js"></script>

    <script>
        $(document).ready(function () {
            // ساخت اتصال SignalR
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/supportHub") // آدرس Hub
                .build();

            // شروع اتصال SignalR
            connection.start().catch(function (err) {
                return console.error(err.toString());
            });

            $('#datepicker').persianDatepicker({
                inline: true,
                format: 'YYYY/MM/DD',
                onSelect: function (unixDate) {
                    const selectedDate = new Date(unixDate).toISOString().split('T')[0];

                    $.ajax({
                        url: '@Url.Action("GetTasks", "Tasks")',
                        type: 'GET',
                        data: { date: selectedDate },
                        success: function (tasks) {
                            $('#taskList').empty();
                            if (tasks.length > 0) {
                                tasks.forEach(task => {
                                    $('#taskList').append(`
                                        <div class="task-item">
                                            <span>${task.title}</span>
                                            <span>${task.isDone ? "انجام شده" : "در انتظار"}</span>
                                            <button class="support-chat-btn" data-ticket-id="${task.ticketId}">
                                                بررسی وظیفه 
                                            </button>
                                        </div>
                                    `);
                                });

                                // افزودن رویداد کلیک برای دکمه‌های چت با پشتیبان
                                $('.support-chat-btn').click(function () {
                                    const ticketId = $(this).data('ticket-id');
                                    // ارسال TicketId به متد LoadMessagesForTicket در SignalR Hub
                                    connection.invoke("LoadMessagesForTicket", ticketId.toString())
                                        .catch(function (err) {
                                            return console.error(err.toString());
                                        });

                                    // همچنین می‌توانید به صفحه چت هدایت کنید
                                    window.location.href = '/Chat/SupportChat?ticketId=' + ticketId;
                                });
                            } else {
                                $('#taskList').append('<p>هیچ وظیفه‌ای برای این تاریخ وجود ندارد.</p>');
                            }
                        },
                        error: function () {
                            $('#taskList').html('<p>خطایی رخ داده است. لطفا دوباره تلاش کنید.</p>');
                        }
                    });
                }
            });
        });
    </script>
}
